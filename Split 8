# Proyecto de Clustering: Segmentaci贸n de Clientes de Centro Comercial
# Autor: [Tu Nombre]
# Fecha: 18 de abril de 2025

# Carga de librer铆as necesarias
library(ggplot2)      # Para visualizaciones
library(cluster)      # Para an谩lisis de clustering y m茅trica de silueta
library(factoextra)   # Para visualizaci贸n de clusters
library(dplyr)        # Para manipulaci贸n de datos

# 1. Carga del dataset
# Establecer el directorio de trabajo si es necesario
# setwd("ruta_a_tu_directorio")

# Cargar el dataset
customers <- read.csv("Mall_Customers.csv")

# Examinar las primeras filas
head(customers)

# 2. Exploraci贸n y limpieza de datos
# Dimensiones del dataset
dim(customers)

# Estructura de los datos
str(customers)

# Resumen estad铆stico
summary(customers)

# Renombrar columnas para facilitar su manejo
colnames(customers) <- c("CustomerID", "Gender", "Age", "AnnualIncome", "SpendingScore")
head(customers)

# Codificar Gender como variable num茅rica (1 para masculino, 0 para femenino)
customers$GenderCode <- ifelse(customers$Gender == "Male", 1, 0)

# Normalizar las variables num茅ricas clave
customers$AnnualIncome_scaled <- scale(customers$AnnualIncome)
customers$SpendingScore_scaled <- scale(customers$SpendingScore)
customers$Age_scaled <- scale(customers$Age)

# 3. Exploraci贸n de variables
# Histograma de la edad
ggplot(customers, aes(x = Age)) +
  geom_histogram(binwidth = 5, fill = "blue", alpha = 0.7) +
  labs(title = "Distribuci贸n de Edad", x = "Edad", y = "Frecuencia")

# Histograma del ingreso anual
ggplot(customers, aes(x = AnnualIncome)) +
  geom_histogram(binwidth = 10, fill = "green", alpha = 0.7) +
  labs(title = "Distribuci贸n de Ingreso Anual", x = "Ingreso Anual (k$)", y = "Frecuencia")

# Histograma de la puntuaci贸n de gasto
ggplot(customers, aes(x = SpendingScore)) +
  geom_histogram(binwidth = 5, fill = "red", alpha = 0.7) +
  labs(title = "Distribuci贸n de Puntuaci贸n de Gasto", x = "Puntuaci贸n de Gasto (1-100)", y = "Frecuencia")

# Distribuci贸n por g茅nero
ggplot(customers, aes(x = Gender, fill = Gender)) +
  geom_bar() +
  labs(title = "Distribuci贸n por G茅nero", x = "G茅nero", y = "Cantidad")

# Diagrama de dispersi贸n de Ingreso vs Puntuaci贸n de Gasto
ggplot(customers, aes(x = AnnualIncome, y = SpendingScore, color = Gender)) +
  geom_point(alpha = 0.7) +
  labs(title = "Ingreso Anual vs Puntuaci贸n de Gasto", x = "Ingreso Anual (k$)", y = "Puntuaci贸n de Gasto")

# 4. Preparaci贸n para clustering
# Seleccionar variables relevantes y escalarlas para clustering
cluster_data <- customers[, c("AnnualIncome_scaled", "SpendingScore_scaled")]

# 5. Entrenamiento del modelo K-Means
# Utilizamos el m茅todo del codo para determinar el n煤mero 贸ptimo de clusters
set.seed(123) # Para reproducibilidad

# Calculamos la suma de cuadrados interna para diferentes n煤meros de clusters
wcss <- vector()
for (i in 1:10) {
  kmeans_model <- kmeans(cluster_data, centers = i, nstart = 25)
  wcss[i] <- kmeans_model$tot.withinss
}

# Gr谩fico del m茅todo del codo
elbow_df <- data.frame(Clusters = 1:10, WCSS = wcss)
ggplot(elbow_df, aes(x = Clusters, y = WCSS)) +
  geom_line(color = "blue") +
  geom_point(color = "red", size = 3) +
  labs(title = "M茅todo del Codo para Determinar N煤mero ptimo de Clusters",
       x = "N煤mero de Clusters", y = "Suma de Cuadrados Interna")

# Basado en el m茅todo del codo, seleccionamos 5 clusters (ajustar seg煤n el gr谩fico)
k_optimal <- 5
set.seed(123)
kmeans_model <- kmeans(cluster_data, centers = k_optimal, nstart = 25)

# Asignar los clusters a los datos originales
customers$KMeans_Cluster <- as.factor(kmeans_model$cluster)

# 6. Clustering Jer谩rquico
# Calcular matriz de distancias
dist_matrix <- dist(cluster_data, method = "euclidean")

# Aplicar clustering jer谩rquico con m茅todo ward.D
hc_model <- hclust(dist_matrix, method = "ward.D")

# Visualizar el dendrograma
plot(hc_model, main = "Dendrograma - Clustering Jer谩rquico", xlab = "", sub = "", cex = 0.6)
# Agregar un rect谩ngulo alrededor de los clusters
rect.hclust(hc_model, k = k_optimal, border = "red")

# Cortar el dendrograma para obtener k_optimal clusters
hc_clusters <- cutree(hc_model, k = k_optimal)

# Asignar los clusters a los datos originales
customers$HC_Cluster <- as.factor(hc_clusters)

# 7. Evaluaci贸n de modelos mediante la m茅trica de silueta
# Calcular silueta para K-Means
sil_kmeans <- silhouette(kmeans_model$cluster, dist_matrix)
avg_sil_width_kmeans <- mean(sil_kmeans[, 3])
cat("Promedio de silueta para K-Means:", avg_sil_width_kmeans, "\n")

# Visualizar silueta para K-Means
plot(sil_kmeans, main = "Silueta - K-Means", col = 1:k_optimal)

# Calcular silueta para Clustering Jer谩rquico
sil_hc <- silhouette(hc_clusters, dist_matrix)
avg_sil_width_hc <- mean(sil_hc[, 3])
cat("Promedio de silueta para Clustering Jer谩rquico:", avg_sil_width_hc, "\n")

# Visualizar silueta para Clustering Jer谩rquico
plot(sil_hc, main = "Silueta - Clustering Jer谩rquico", col = 1:k_optimal)

# Determinar el mejor modelo basado en silueta
best_model <- ifelse(avg_sil_width_kmeans > avg_sil_width_hc, "K-Means", "Jer谩rquico")
cat("El mejor modelo seg煤n la m茅trica de silueta es:", best_model, "\n")

# 8. An谩lisis descriptivo de segmentos
# Para K-Means (suponiendo que es el mejor modelo, ajustar si no lo es)
cluster_stats_kmeans <- customers %>%
  group_by(KMeans_Cluster) %>%
  summarise(
    Conteo = n(),
    Porcentaje = n() / nrow(customers) * 100,
    Edad_Media = mean(Age),
    Ingreso_Medio = mean(AnnualIncome),
    Puntaje_Gasto_Medio = mean(SpendingScore),
    Proporcion_Hombres = mean(GenderCode) * 100
  )

print(cluster_stats_kmeans)

# Para Clustering Jer谩rquico
cluster_stats_hc <- customers %>%
  group_by(HC_Cluster) %>%
  summarise(
    Conteo = n(),
    Porcentaje = n() / nrow(customers) * 100,
    Edad_Media = mean(Age),
    Ingreso_Medio = mean(AnnualIncome),
    Puntaje_Gasto_Medio = mean(SpendingScore),
    Proporcion_Hombres = mean(GenderCode) * 100
  )

print(cluster_stats_hc)

# 9. Visualizaci贸n de clusters
# Visualizaci贸n para K-Means
ggplot(customers, aes(x = AnnualIncome, y = SpendingScore, color = KMeans_Cluster)) +
  geom_point(size = 3, alpha = 0.7) +
  labs(title = "Segmentaci贸n de Clientes con K-Means",
       x = "Ingreso Anual (k$)", y = "Puntuaci贸n de Gasto",
       color = "Cluster") +
  theme_minimal()

# Visualizaci贸n mejorada con fviz_cluster para K-Means
fviz_cluster(kmeans_model, data = cluster_data,
             geom = "point", ellipse.type = "convex",
             palette = "jco", ggtheme = theme_minimal(),
             main = "Segmentaci贸n con K-Means")

# Visualizaci贸n para Clustering Jer谩rquico
ggplot(customers, aes(x = AnnualIncome, y = SpendingScore, color = HC_Cluster)) +
  geom_point(size = 3, alpha = 0.7) +
  labs(title = "Segmentaci贸n de Clientes con Clustering Jer谩rquico",
       x = "Ingreso Anual (k$)", y = "Puntuaci贸n de Gasto",
       color = "Cluster") +
  theme_minimal()

# 10. Interpretaci贸n b谩sica de los perfiles de cada cluster
# (Basado en el mejor modelo seg煤n m茅trica de silueta)

# Si el mejor modelo es K-Means
if (best_model == "K-Means") {
  cat("\nInterpretaci贸n de los perfiles de clusters (K-Means):\n")
  
  for (i in 1:k_optimal) {
    profile <- cluster_stats_kmeans[cluster_stats_kmeans$KMeans_Cluster == i, ]
    cat(paste0("\nCluster ", i, ":"))
    cat(paste0("\n- Tama帽o: ", round(profile$Conteo, 2), " clientes (", round(profile$Porcentaje, 2), "%)"))
    cat(paste0("\n- Edad media: ", round(profile$Edad_Media, 2), " a帽os"))
    cat(paste0("\n- Ingreso medio: ", round(profile$Ingreso_Medio, 2), " k$"))
    cat(paste0("\n- Puntuaci贸n de gasto media: ", round(profile$Puntaje_Gasto_Medio, 2), "/100"))
    cat(paste0("\n- Proporci贸n de hombres: ", round(profile$Proporcion_Hombres, 2), "%\n"))
    
    # Interpretaci贸n personalizada seg煤n caracter铆sticas
    if (profile$Ingreso_Medio > 75 && profile$Puntaje_Gasto_Medio > 75) {
      cat("   Clientes con alto ingreso y alto gasto (clientes premium)\n")
    } else if (profile$Ingreso_Medio > 75 && profile$Puntaje_Gasto_Medio < 50) {
      cat("   Clientes con alto ingreso pero bajo gasto (potencial desaprovechado)\n")
    } else if (profile$Ingreso_Medio < 50 && profile$Puntaje_Gasto_Medio > 75) {
      cat("   Clientes con bajo ingreso pero alto gasto (compradores entusiastas)\n")
    } else if (profile$Ingreso_Medio < 50 && profile$Puntaje_Gasto_Medio < 50) {
      cat("   Clientes con bajo ingreso y bajo gasto (compradores conscientes)\n")
    } else {
      cat("   Clientes con valores medios (clientes moderados)\n")
    }
  }
} else {
  # Si el mejor modelo es Jer谩rquico
  cat("\nInterpretaci贸n de los perfiles de clusters (Jer谩rquico):\n")
  
  for (i in 1:k_optimal) {
    profile <- cluster_stats_hc[cluster_stats_hc$HC_Cluster == i, ]
    cat(paste0("\nCluster ", i, ":"))
    cat(paste0("\n- Tama帽o: ", round(profile$Conteo, 2), " clientes (", round(profile$Porcentaje, 2), "%)"))
    cat(paste0("\n- Edad media: ", round(profile$Edad_Media, 2), " a帽os"))
    cat(paste0("\n- Ingreso medio: ", round(profile$Ingreso_Medio, 2), " k$"))
    cat(paste0("\n- Puntuaci贸n de gasto media: ", round(profile$Puntaje_Gasto_Medio, 2), "/100"))
    cat(paste0("\n- Proporci贸n de hombres: ", round(profile$Proporcion_Hombres, 2), "%\n"))
    
    # Interpretaci贸n personalizada seg煤n caracter铆sticas
    if (profile$Ingreso_Medio > 75 && profile$Puntaje_Gasto_Medio > 75) {
      cat("   Clientes con alto ingreso y alto gasto (clientes premium)\n")
    } else if (profile$Ingreso_Medio > 75 && profile$Puntaje_Gasto_Medio < 50) {
      cat("   Clientes con alto ingreso pero bajo gasto (potencial desaprovechado)\n")
    } else if (profile$Ingreso_Medio < 50 && profile$Puntaje_Gasto_Medio > 75) {
      cat("   Clientes con bajo ingreso pero alto gasto (compradores entusiastas)\n")
    } else if (profile$Ingreso_Medio < 50 && profile$Puntaje_Gasto_Medio < 50) {
      cat("   Clientes con bajo ingreso y bajo gasto (compradores conscientes)\n")
    } else {
      cat("   Clientes con valores medios (clientes moderados)\n")
    }
  }
}

# 11. Comparaci贸n de coincidencia entre los dos m茅todos de clustering
comparison_table <- table(customers$KMeans_Cluster, customers$HC_Cluster)
print("Tabla de contingencia de asignaci贸n de clusters entre K-Means y Jer谩rquico:")
print(comparison_table)

# Calcular el porcentaje de coincidencia
coincidencias <- sum(diag(comparison_table))
total_observaciones <- sum(comparison_table)
porcentaje_coincidencia <- coincidencias / total_observaciones * 100
cat("Porcentaje de coincidencia entre los dos m茅todos:", round(porcentaje_coincidencia, 2), "%\n")

# 12. Exportar los resultados (opcional)
# Guardar el dataset con las asignaciones de clusters
write.csv(customers, "mall_customers_clustered.csv", row.names = FALSE)

# Conclusi贸n
cat("\n=== CONCLUSIN DEL ANLISIS ===\n")
cat("Se han aplicado dos t茅cnicas de clustering (K-Means y Jer谩rquico) al dataset de clientes del centro comercial.\n")
cat("El n煤mero 贸ptimo de clusters determinado por el m茅todo del codo es:", k_optimal, "\n")
cat("El modelo con mejor rendimiento seg煤n la m茅trica de silueta es:", best_model, 
    "con un valor promedio de silueta de:", 
    ifelse(best_model == "K-Means", round(avg_sil_width_kmeans, 4), round(avg_sil_width_hc, 4)), "\n")
cat("Los resultados permiten identificar segmentos de clientes con diferentes perfiles de comportamiento de compra.\n")
cat("Estos segmentos pueden utilizarse para estrategias de marketing personalizadas y optimizaci贸n de la experiencia del cliente.\n")
